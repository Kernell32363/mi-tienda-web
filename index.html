<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyASur.Ok - Vapers & Fragancias Gold</title>
    
    <!-- Script de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuente Inter de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Iconos de Lucide -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        /* Definición de la Paleta Metalizada */
        :root {
            --color-black-deep: #0A0A0A;    /* Fondo casi puro */
            --color-silver: #D4D4D4;        /* Texto principal */
            --color-gold: #FFD700;          /* Acento principal (Botones) */
            --color-rosegold: #B76E79;      /* Acento secundario (Subtítulos/bordes) */
        }

        /* Aplicamos la fuente Inter y el fondo Negro Profundo */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: var(--color-black-deep);
            color: var(--color-silver); 
        }

        .text-metallic-gradient {
            background-image: linear-gradient(45deg, #B8860B, #C3894B, #D4D4D4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        .bg-deep-black { background-color: var(--color-black-deep); }
        .text-gold { color: var(--color-gold); }
        .text-rosegold { color: var(--color-rosegold); }
        .border-rosegold { border-color: var(--color-rosegold); }
        
        .card-soft-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(255, 215, 0, 0.1), 0 2px 4px -2px rgba(255, 215, 0, 0.05);
            background-color: #1a1a1a;
        }
        .card-soft-hover:hover {
            transform: translateY(-5px); 
            box-shadow: 0 15px 25px rgba(255, 215, 0, 0.2); 
            background-color: #262626;
        }

        .hero-background {
            background-image: url(https://disfragancias.com/cdn/shop/articles/envato-labs-ai-214adbf0-56f6-4e7e-a959-63afb6bff051_1024x1024.jpg?v=1750277775); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .instagram-btn-wrapper {
            padding: 2px;
            border-radius: 9999px;
            background: linear-gradient(45deg, var(--color-gold), var(--color-rosegold), var(--color-silver));
            display: inline-flex;
            transition: transform 0.3s ease;
        }
        .instagram-btn-wrapper:hover {
            transform: scale(1.15);
        }

        /* Offcanvas */
        #cart-offcanvas {
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
        }
        #cart-offcanvas.open {
            transform: translateX(0);
        }
        #backdrop {
            transition: opacity 0.3s ease-out;
        }
        
        /* Input styles */
        input, textarea {
            background-color: #000000 !important;
            border-color: #333 !important;
            color: #D4D4D4 !important;
        }
        input:focus, textarea:focus {
            border-color: var(--color-rosegold) !important;
            ring-color: var(--color-rosegold) !important;
        }
    </style>
</head>
<body class="bg-deep-black text-silver">

    <!-- ===== MODAL CARRITO (SIDEBAR) ===== -->
    <div id="backdrop" class="fixed inset-0 bg-black bg-opacity-80 z-40 hidden" onclick="closeCart()"></div>

    <div id="cart-offcanvas" class="fixed top-0 right-0 w-full md:w-96 h-full bg-[#111] shadow-2xl z-50 flex flex-col border-l border-gray-800">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-2xl font-bold text-metallic-gradient">Tu Carrito</h2>
            <button onclick="closeCart()" class="text-gray-400 hover:text-gold transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div id="user-info" class="px-6 py-2 text-xs font-mono text-gray-500 truncate border-b border-gray-900">
            ID: Cargando...
        </div>

        <!-- Lista de Productos -->
        <div id="cart-items-container" class="flex-grow overflow-y-auto p-6 space-y-4">
            <p id="empty-cart-message" class="text-gray-500 text-center italic mt-10">Tu carrito está vacío.</p>
        </div>

        <!-- Footer del Carrito -->
        <div class="p-6 border-t border-gray-800 bg-[#0A0A0A]">
            <div class="flex justify-between font-medium text-lg text-silver mb-2">
                <span>Cantidad:</span>
                <span id="modal-total-quantity">0</span>
            </div>
            <div class="flex justify-between font-bold text-2xl text-gold mb-6">
                <span>Total:</span>
                <span id="cart-total-price">$0 ARS</span>
            </div>

            <button id="checkout-button" onclick="checkoutToWhatsApp()" 
                    class="w-full py-4 bg-gold text-black font-bold rounded-lg hover:bg-yellow-500 transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                Finalizar en WhatsApp
            </button>
        </div>
        
        <div id="status-message" class="p-2 text-center text-xs hidden"></div>
    </div>

    <!-- ===== NAVEGACIÓN (Negro) ===== -->
    <nav class="bg-black/90 shadow-xl sticky top-0 z-50 border-b border-gray-800">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- Título: Aplicamos el degradado -->
            <h1 class="text-2xl font-extrabold tracking-widest text-metallic-gradient">EyASur.Ok</h1>
            
            <!-- Menú para computadoras (Texto Plata/Oro para mantener legibilidad) -->
            <div class="hidden md:flex space-x-6">
                <a href="#inicio" class="text-silver hover:text-gold transition-colors font-medium">Inicio</a>
                <a href="#productos" class="text-silver hover:text-gold transition-colors font-medium">Productos</a>
                <a href="#contacto" class="text-silver hover:text-gold transition-colors font-medium">Contacto</a>
            </div>

                <!-- Botón Carrito (Navbar) -->
                <button onclick="openCart()" class="relative p-2 text-silver hover:text-gold transition-colors">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="navbar-cart-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-black bg-gold rounded-full hidden">
                        0
                    </span>
                </button>
                
            <!-- Botón de Menú Móvil -->
            <button id="mobile-menu-button" class="text-silver hover:text-gold md:hidden">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
        
        <!-- Menú Móvil (Gris muy oscuro) -->
        <div id="mobile-menu" class="md:hidden bg-[#1a1a1a] shadow-xl hidden">
            <a href="#inicio" class="block px-6 py-3 text-silver hover:text-gold hover:bg-[#262626]">Inicio</a>
            <a href="#productos" class="block px-6 py-3 text-silver hover:text-gold hover:bg-[#262626]">Productos</a>
            <a href="#contacto" class="block px-6 py-3 text-silver hover:text-gold hover:bg-[#262626]">Contacto</a>
        </div>
    </nav>

    <!-- ===== SECCIÓN DE INICIO (HERO) - CON IMAGEN DE FONDO ===== -->
    <header id="inicio" class="hero-background text-white min-h-[70vh] flex items-center relative z-10 shadow-inner">
        <div class="absolute inset-0 bg-black opacity-70"></div> 
        
        <div class="container mx-auto px-6 py-12 text-center relative z-10">
            <!-- Título principal: Aplicamos el degradado -->
            <h2 class="text-5xl md:text-6xl font-extrabold mb-4 tracking-tight text-metallic-gradient">Fragancias y Vapers Exclusivos</h2>
            <!-- Subtítulo en Oro Rosa sutil -->
            <p class="text-xl md:text-2xl mb-10 text-rosegold font-light">Descubre la calidad premium que te mereces. Envío a todo el país.</p>
            
            <!-- Botón Principal en ORO -->
            <a href="#productos" class="bg-gold text-black font-semibold py-3 px-10 rounded-full shadow-lg hover:bg-[#E5C100] transition duration-300 transform hover:scale-105">
                Explorar Colección
            </a>
        </div>
    </header>

    <main class="container mx-auto px-6 py-20">

        <!-- ===== SECCIÓN SOBRE NOSOTROS (Panel Oscuro con borde Cobre) ===== -->
        <section id="sobre" class="mb-24 text-center max-w-4xl mx-auto p-8 rounded-xl bg-gray-900 text-silver card-soft-hover border border-rosegold/50">
            <!-- Título: Aplicamos el degradado -->
            <h3 class="text-4xl font-bold mb-6 text-metallic-gradient">Nuestra Pasión</h3>
            <p class="leading-relaxed text-lg text-gray-400">
                En EyASur.Ok, nos especializamos en la comercialización de <strong class="text-metallic-gradient font-bold">Exquisitas Fragancias Importadas</strong> y los <strong class="text-metallic-gradient font-bold">Mejores Vapers Desechables</strong> del mercado. Nuestro compromiso es ofrecer productos de máxima calidad, autenticidad garantizada y una experiencia de compra sencilla y segura.
            </p>
        </section>


        <!-- ===== PRODUCTOS ===== -->
        <section id="productos">
            <h3 class="text-4xl font-bold mb-12 text-center text-metallic-gradient">Catálogo Destacado</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">

                <!-- Producto 1 -->
                <div class="card-soft-hover rounded-xl shadow-2xl overflow-hidden flex flex-col border border-rosegold/30">
                    <div class="relative h-72 border-b border-gray-800">
                        <img src="https://placehold.co/600x400/0A0A0A/FFD700?text=FRAGANCIA" class="absolute inset-0 w-full h-full object-cover" alt="Fragancia">
                        <div class="absolute inset-0 bg-black/40"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h4 class="text-3xl font-extrabold text-white relative z-10">Fragancia</h4>
                        </div>
                    </div>
                    <div class="p-6 flex-grow">
                        <h4 class="text-2xl font-semibold mb-2 text-metallic-gradient">Perfume Élite Noir</h4>
                        <p class="text-gray-400 mb-4 text-sm">Fragancia amaderada y especiada. Importada, 100ml.</p>
                    </div>
                    <div class="p-6 pt-0 flex justify-between items-center border-t border-gray-800">
                        <span class="text-3xl font-extrabold text-gold">$65.000 ARS</span>
                        <button onclick="addToCart({ id: 'P001', name: 'Perfume Élite Noir', price: 65000, qty: 1 })" 
                           class="bg-gold text-black py-2 px-6 rounded-lg font-bold hover:bg-yellow-400 transition-colors flex items-center gap-2">
                           <i data-lucide="plus" class="w-4 h-4"></i> Agregar
                        </button>
                    </div>
                </div>

                <!-- Producto 2 -->
                <div class="card-soft-hover rounded-xl shadow-2xl overflow-hidden flex flex-col border border-rosegold/30">
                    <div class="relative h-72 border-b border-gray-800">
                        <img src="https://placehold.co/600x400/0A0A0A/D4D4D4?text=VAPER" class="absolute inset-0 w-full h-full object-cover" alt="Vaper">
                        <div class="absolute inset-0 bg-black/40"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h4 class="text-3xl font-extrabold text-white relative z-10">Vaper</h4>
                        </div>
                    </div>
                    <div class="p-6 flex-grow">
                        <h4 class="text-2xl font-semibold mb-2 text-metallic-gradient">Vaper Max Puff</h4>
                        <p class="text-gray-400 mb-4 text-sm">5000 Puffs. Sabor Frutos Rojos. Nicotina 5%.</p>
                    </div>
                    <div class="p-6 pt-0 flex justify-between items-center border-t border-gray-800">
                        <span class="text-3xl font-extrabold text-gold">$8.500 ARS</span>
                        <button onclick="addToCart({ id: 'P002', name: 'Vaper Max Puff', price: 8500, qty: 1 })" 
                           class="bg-gold text-black py-2 px-6 rounded-lg font-bold hover:bg-yellow-400 transition-colors flex items-center gap-2">
                           <i data-lucide="plus" class="w-4 h-4"></i> Agregar
                        </button>
                    </div>
                </div>

                <!-- Producto 3 -->
                <div class="card-soft-hover rounded-xl shadow-2xl overflow-hidden flex flex-col border border-rosegold/30">
                    <div class="relative h-72 border-b border-gray-800">
                        <img src="https://placehold.co/600x400/0A0A0A/B76E79?text=SET+LUJO" class="absolute inset-0 w-full h-full object-cover" alt="Set">
                        <div class="absolute inset-0 bg-black/40"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h4 class="text-3xl font-extrabold text-white relative z-10">Set de Lujo</h4>
                        </div>
                    </div>
                    <div class="p-6 flex-grow">
                        <h4 class="text-2xl font-semibold mb-2 text-metallic-gradient">Set Black Collection</h4>
                        <p class="text-gray-400 mb-4 text-sm">Incluye mini-perfume exclusivo y accesorio vaper.</p>
                    </div>
                    <div class="p-6 pt-0 flex justify-between items-center border-t border-gray-800">
                        <span class="text-3xl font-extrabold text-gold">$95.000 ARS</span>
                        <button onclick="addToCart({ id: 'P003', name: 'Set Black Collection', price: 95000, qty: 1 })" 
                           class="bg-gold text-black py-2 px-6 rounded-lg font-bold hover:bg-yellow-400 transition-colors flex items-center gap-2">
                           <i data-lucide="plus" class="w-4 h-4"></i> Agregar
                        </button>
                    </div>
                </div>

            </div>
        </section>
        
        <!-- ===== CONTACTO ===== -->
        <section id="contacto" class="mt-28 bg-white p-10 md:p-16 rounded-xl shadow-2xl max-w-4xl mx-auto border-t-4 border-primary-gold">
            <h3 class="text-4xl font-bold mb-8 text-center text-metallic-gradient">¡Hablemos!</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                
                <div class="space-y-6">
                    <p class="text-gray-600 text-lg">Contáctanos directamente para pedidos y envíos.</p>
                    <div class="flex items-center space-x-4">
                        <i data-lucide="mail" class="w-6 h-6 text-rosegold"></i>
                        <span class="text-silver">tuemail@ejemplo.com</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <i data-lucide="phone" class="w-6 h-6 text-rosegold"></i>
                        <span class="text-silver">+54 9 11 1234-5678</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <i data-lucide="map-pin" class="w-6 h-6 text-rosegold"></i>
                        <span class="text-silver">Retiro y Envíos a todo Argentina</span>
                    </div>
                    <a href="https://wa.me/5491112345678" target="_blank" class="block mt-6 bg-black/80 text-center py-3 rounded-lg font-bold border border-rosegold/50 hover:bg-[#1a1a1a] transform hover:scale-[1.01] shadow-xl">
                        <span class="text-metallic-gradient flex items-center justify-center gap-2">
                            <i data-lucide="message-circle" class="w-5 h-5"></i> Escríbenos por WhatsApp
                        </span>
                    </a>
                </div>
                
                <form action="https://formsubmit.co/ericdavidmorgan.dc@gmail.com" method="POST" class="space-y-4">
                    <input type="hidden" name="_captcha" value="false">
                    <input type="text" name="name" placeholder="Nombre" required class="w-full px-4 py-3 rounded-lg focus:outline-none">
                    <input type="email" name="email" placeholder="Email" required class="w-full px-4 py-3 rounded-lg focus:outline-none">
                    <textarea name="message" rows="4" placeholder="Mensaje" required class="w-full px-4 py-3 rounded-lg focus:outline-none"></textarea>
                    <button type="submit" class="w-full bg-gold text-black py-3 rounded-lg font-bold hover:bg-yellow-500 transition-colors shadow-lg">
                        Enviar Mensaje
                    </button>
                </form>
            </div>
        </section>

    </main>

      <!-- ===== SECCIÓN SOCIAL MEDIA (Instagram con acento Oro/Rosegold) ===== -->
    <section class="text-center pt-10 pb-16 bg-gray-900/50">
        <!-- Tarjeta de tinte más oscuro y borde Rose Gold sutil -->
        <div class="max-w-xs mx-auto p-6 rounded-xl bg-gray-900 border border-rosegold/50 card-soft-hover">
            <!-- Título: Aplicamos el degradado -->
            <h4 class="text-xl font-semibold mb-4 text-metallic-gradient">Síguenos en Instagram</h4>
            <!-- Botón con el borde degradado Oro/Plata/Rose Gold -->
            <div class="instagram-btn-wrapper">
                <a href="https://www.instagram.com/eyasur.ok?utm_source=qr&igsh=cG1uNjZkajFtN2k3" target="_blank" class="inline-flex items-center justify-center p-3 rounded-full bg-gray-900">
                    <i data-lucide="instagram" class="w-8 h-8 text-rosegold"></i>
                </a>
            </div>
            <p class="text-xs text-gray-500 mt-4">@EyASur.Ok</p>
        </div>
    </section>

    <!-- ===== FOOTER (PIE DE PÁGINA) ===== -->
    <footer class="bg-black border-t border-rosegold/50 text-gray-500">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2025-2026 EyASur.Ok. Todos los derechos reservados.</p>
            <p class="text-sm mt-2">Diseño Gold por EDM</p>
            <p class="text-sm mt-2">Creado con Amor ❤️ por EyASur.OK</p>
        </div>
    </footer>

    <!-- Script para los iconos y el menú móvil -->
    <script>
        // Lógica para el menú móvil
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        if (menuButton && mobileMenu) {
            menuButton.addEventListener('click', () => {
                const icon = menuButton.querySelector('i');
                const isHidden = mobileMenu.classList.contains('hidden');
                mobileMenu.classList.toggle('hidden');
                
                // Cambiar el icono (menu a x)
                if (isHidden) {
                    icon.setAttribute('data-lucide', 'x');
                } else {
                    icon.setAttribute('data-lucide', 'menu');
                }
                
                // Volver a renderizar los iconos de Lucide
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }

        // Reemplaza todos los iconos de Lucide una vez que el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error('El script de Lucide (iconos) no se cargó correctamente.');
            }
        });

    </script>

    <div id="message-container" class="fixed bottom-4 right-4 z-[200] space-y-2"></div>

    <!-- LÓGICA JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN FIREBASE ---
        // 1. Intentamos leer variables del entorno (Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const canvasConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 2. Definimos tus claves manuales (FALLBACK)
        const MANUAL_CONFIG = {
          apiKey: "AIzaSyBI51rUSOhyJFzhchADiEEMGQBM6eumD5A",
          authDomain: "eyasur-ab07f.firebaseapp.com",
          projectId: "eyasur-ab07f",
          storageBucket: "eyasur-ab07f.firebasestorage.app",
          messagingSenderId: "394656799972",
          appId: "1:394656799972:web:dae4f4943f3975abe360f1"
        };

        // 3. Lógica de selección de configuración
        let firebaseConfig = MANUAL_CONFIG; // Por defecto usamos las tuyas

        if (canvasConfigStr) {
            try {
                const parsedConfig = JSON.parse(canvasConfigStr);
                // Si la config del entorno tiene apiKey, la usamos. Si no, nos quedamos con MANUAL_CONFIG.
                if (parsedConfig && parsedConfig.apiKey) {
                    firebaseConfig = parsedConfig;
                }
            } catch (e) {
                console.error("Error parseando config canvas, usando manual", e);
            }
        }

        let app, db, auth, userId = null, cartRef = null;
        window.cartItems = []; 

        async function initApp() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const idDisplay = document.getElementById('app-id-display');
            if(idDisplay) idDisplay.textContent = appId;

            // --- AUTENTICACIÓN ROBUSTA ---
            try {
                // Intentamos usar el token del entorno si existe
                if (initialToken) {
                     await signInWithCustomToken(auth, initialToken);
                } else {
                     // Si no hay token, inicio anónimo directo
                     await signInAnonymously(auth);
                }
            } catch(e) { 
                console.warn("Fallo auth inicial, reintentando anónimo...", e);
                try {
                   await signInAnonymously(auth);
                } catch(e2) {
                    console.error("Error fatal auth anónimo. Verifica tus claves en MANUAL_CONFIG.", e2);
                    showMessage("Error de Autenticación. Revisa la consola.", "red");
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    const idEl = document.getElementById('current-user-id');
                    if(idEl) idEl.textContent = userId;
                    
                    // Ruta del carrito: Por usuario
                    cartRef = doc(db, 'artifacts', appId, 'users', userId, 'cart', 'current');
                    setupCartListener();
                    showMessage("Conectado al Carrito", "gold");
                }
            });
        }

        // --- FUNCIONES UI ---
        function updateCartUI(items) {
            window.cartItems = items || [];
            
            const container = document.getElementById('cart-items-container');
            const navbarBadge = document.getElementById('navbar-cart-count');
            const totalPriceEl = document.getElementById('cart-total-price');
            const totalQtyEl = document.getElementById('modal-total-quantity');
            const emptyMsg = document.getElementById('empty-cart-message');
            const btnCheckout = document.getElementById('checkout-button');

            if (!container) return;

            container.innerHTML = '';
            let total = 0;
            let qty = 0;

            if (window.cartItems.length === 0) {
                if(emptyMsg) emptyMsg.classList.remove('hidden');
                if(btnCheckout) {
                    btnCheckout.disabled = true;
                    btnCheckout.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                if(emptyMsg) emptyMsg.classList.add('hidden');
                if(btnCheckout) {
                    btnCheckout.disabled = false;
                    btnCheckout.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                window.cartItems.forEach(item => {
                    const p = parseInt(item.price);
                    const q = parseInt(item.qty);
                    total += p * q;
                    qty += q;

                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-[#111] rounded-lg border border-gray-800 shadow-sm';
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-medium text-silver">${item.name}</span>
                            <span class="text-xs text-gray-500">$${p.toLocaleString()} x ${q}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="updateQuantity('${item.id}', -1)" class="text-gray-500 hover:text-rosegold"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
                            <span class="text-gold font-bold">${q}</span>
                            <button onclick="updateQuantity('${item.id}', 1)" class="text-gray-500 hover:text-gold"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 ml-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            if (navbarBadge) {
                navbarBadge.innerText = qty;
                if(qty === 0) navbarBadge.classList.add('hidden');
                else navbarBadge.classList.remove('hidden');
            }

            if (totalPriceEl) totalPriceEl.innerText = `$${total.toLocaleString()} ARS`;
            if (totalQtyEl) totalQtyEl.innerText = qty;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function setupCartListener() {
            if (!cartRef) return;
            onSnapshot(cartRef, (snap) => {
                if (snap.exists()) updateCartUI(snap.data().items);
                else updateCartUI([]);
            });
        }

        async function saveCart(items) {
            if (!cartRef) return;
            await setDoc(cartRef, { items: items, updatedAt: new Date().toISOString() }, { merge: true });
        }

        // --- FUNCIONES GLOBALES ---
        window.addToCart = function(product) {
            if (!userId) { showMessage("Cargando...", "red"); return; }
            let items = [...window.cartItems];
            const idx = items.findIndex(i => i.id === product.id);
            
            if (idx > -1) {
                const current = parseInt(items[idx].qty || 0);
                items[idx].qty = current + 1;
            } else {
                items.push({ ...product, qty: 1 });
            }

            updateCartUI(items); 
            saveCart(items);
            showMessage("Agregado al carrito", "gold");
            window.openCart();
        };

        window.updateQuantity = function(id, delta) {
            let items = [...window.cartItems];
            const idx = items.findIndex(i => i.id === id);
            if (idx > -1) {
                const current = parseInt(items[idx].qty || 0);
                items[idx].qty = current + delta;
                if (items[idx].qty <= 0) items.splice(idx, 1);
                updateCartUI(items);
                if(cartRef) saveCart(items);
            }
        };

        window.removeFromCart = function(id) {
            const items = window.cartItems.filter(i => i.id !== id);
            updateCartUI(items);
            if(cartRef) saveCart(items);
        };

        window.checkoutToWhatsApp = function() {
            if (window.cartItems.length === 0) return;
            let msg = "Hola EyASur! Pedido:\n";
            let total = 0;
            window.cartItems.forEach(i => {
                msg += `- ${i.name} (${i.qty}): $${(i.price*i.qty).toLocaleString()}\n`;
                total += i.price * i.qty;
            });
            msg += `Total: $${total.toLocaleString()}`;
            window.open(`https://wa.me/5491112345678?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.openCart = () => {
            document.getElementById('cart-offcanvas').classList.add('open');
            document.getElementById('backdrop').classList.remove('hidden');
        };
        window.closeCart = () => {
            document.getElementById('cart-offcanvas').classList.remove('open');
            document.getElementById('backdrop').classList.add('hidden');
        };

        window.showMessage = (msg, color) => {
            const box = document.getElementById('message-container');
            if(!box) return;
            const d = document.createElement('div');
            const c = color === 'gold' ? 'bg-gold/20 text-gold border-gold' : 'bg-red-900/80 text-white border-red-500';
            d.className = `p-3 rounded border ${c} mb-2 backdrop-blur`;
            d.innerText = msg;
            box.appendChild(d);
            setTimeout(() => d.remove(), 3000);
        };

        const menuBtn = document.getElementById('mobile-menu-button');
        const menu = document.getElementById('mobile-menu');
        if(menuBtn) menuBtn.onclick = () => menu.classList.toggle('hidden');

        initApp();
    </script>
</body>
</html>
